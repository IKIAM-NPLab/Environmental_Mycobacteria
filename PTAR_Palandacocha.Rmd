---
title: "Análisis de datos de Micobacterias ambientales presentes en la Planta de tratamiento de aguas residuales Palandacocha"
author: "Silvana Morocho, Jefferson Pastuña"
date: "2023-10-09"
output:
  github_document:
    toc: true
    toc_depth: 3
always_allow_html: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
usethis::git_vaccinate()

```

# Introducción

General...

# Identificación Molecular

Previo la identificación molecular de las posibles especies, se realizó el control de calidad de la secuenciación Sanger (electroferograma) con el paquete [sangeranalyseR](https://github.com/roblanf/sangeranalyseR) de R.

## Preprocesamiento

A continuación, se instaló el paquete sangeranalyseR para el preprocesamiento de los electroferogramas obtenidos de la secuenciación Sanger.

```{r sanger, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

#Instalación y cargado de bibliotecas del paquete sangeranalyseR
#if (!requireNamespace("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
#BiocManager::install("sangeranalyseR")

library(sangeranalyseR)

```

Se procedió a cargar los electroferogramas (*.ab1) para el análisis.

```{r files, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Directorio/carpeta de trabajo
ppath <- "C:/Users/F4ss0/Documents/Ikiam21062022/Environmental_Mycobacteria/"
# Carpeta con los datos Sanger
sanger_files <- file.path(ppath, "Data", "palandacocha_sanger")
# Confirmamos la precencia de los archivos Sanger en la carpeta
#list.files(sanger_files)
# Filtramos la ruta de los archivos (*.ab1)
ab1_files <- list.files(path = sanger_files, pattern = "[.]ab1", full.names = TRUE)

```

Unas vez cargadas las secuencias (*.ab1) se procedió con el control de calidad de las mismas. Para ello se tomaron en cuenta los parámetro  recomendados en el trabajo de [Crossley  (2020)](https://doi.org/10.1177%2F1040638720905833). El puntaje de recortado de lectura usado fue 30 (recomendado > 20) usando el método modificado de Mott. El ruido se estableció en 33 % (recomendado < 20 %), con este valor consideramos picos/bases que al menos sean 1/3 del pico más alto (de la secuencia pricipal).

### Ejemplo para un cromatograma

A continuación, se exploran los parámetros con un electroferograma de ejemplo.

```{r load_test, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Cragado del archivo ejemplo
file_test <- file.path(ppath,
                      "Data",
                      "palandacocha_sanger",
                      "A1-F-12Y_F08_06.ab1")
# Control de calidad de los nucleótidos
clean_test <- SangerRead(printLevel = "SangerRead",
                           inputSource = "ABIF",
                           readFeature = "Forward Read",
                           readFileName = file_test,
                           geneticCode = GENETIC_CODE,
                           TrimmingMethod = "M1",
                           M1TrimmingCutoff = 0.001, # Para Q = 30
                           baseNumPerRow = 100,
                           heightPerRow = 200,
                           signalRatioCutoff = 0.33,
                           showTrimmed = TRUE)
clean_test

```

Como resultado se obtuvo una secuencia más corta que la inicial con pares de bases (BP) de calidad establecida por el usuario (Q = 30).

También podemos observar el recorte realizada a la secuencia inicial y la calidad de las pares de bases (BP) presentes en la secuencia.

```{r plot_test, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

qual_test <- qualityBasePlot(clean_test)
qual_test

```

Finalmente, la secuencia será exportada en formato (*.fa) para análisis posteriores.

```{r export_test, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Directorio para guardar los cromatogramas tratados
results_files <- file.path(ppath, "Result", "palandacocha_results")
# Exportación del cromatograma preprocesado
exp_test  <- writeFasta(clean_test,
                        outputDir = results_files,
                        compress = FALSE,
                        compression_level = NA)

```

Una vez obtenidos los parámetros adecuados, se procede a aplicar dichos parámetros para todos los electroferograma.

```{r clean, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Creamos una lista vacía
all_ab1 <- list()
# Creamos un bucle for para leer todos los archivos
#for(i in 1:24){
#  sanger_read <- SangerRead(printLevel = "SangerRead",
#                           inputSource = "ABIF",
#                           readFeature = "Forward Read",
#                           readFileName = ab1_files[i],
#                           geneticCode = GENETIC_CODE,
#                           TrimmingMethod = "M1",
#                           M1TrimmingCutoff = 0.001, # Para Q = 30
#                           M2CutoffQualityScore = NULL,
#                           M2SlidingWindowSize = NULL,
#                           baseNumPerRow = 100,
#                           heightPerRow = 200,
#                           signalRatioCutoff = 0.33,
#                           showTrimmed = TRUE)
#  all_ab1[[i]] <- sanger_read
#  writeFasta(sanger_read,
#           outputDir = results_files,
#           compress = FALSE,
#           compression_level = NA)
#}

```

# Estadística

Se usarán índices de diversidad en cada punto de muestreo para un seguimiento al tratamiento de las aguas residuales que realiza la planta Palandacocha. En cambio, todas las especies identificadas en la planta serán consideradas como la diversidad de Micobacterias presentes en las aguas residuales del cantón Tena (representado por aquellas que llegan a la planta Palandacocha).

## Diversidad Alfa

Los índices de diversidad más usados en la literatura son Simpson y Shannon (cita). El índice de Simpson está relacionado con la dominancia de las especies en un área o ecosistema en particular (cita). En este caso se calculará el índice de Simpson en muestras (área o punto de muestreo) antes del ingreso, dentro y a la salida de la planta de tratamiento Palandacocha. De existir una especie dominante a la salida de la planta podría deberse a la resistencia del microorganismo a los métodos descontaminantes empleadas en la planta.

Por otro lado, el índice de Shannon está relacionado a la equidad/uniformidad de las especies en un área o ecosistema en particular (cita). Este estadístico nos permitirá conocer si las diferentes áreas muestrales son iguales, más o menos uniformes. De esta manera, la uniformidad semejante entre los sitios muéstreles podría deberse a la resistencia de los microrganismos a los métodos de descontaminación empleadas en la planta de Palandacocha.

Para los cálculos de la diversidad alfa se usará el paquete R [vegan](https://github.com/vegandevs/vegan/tree/master) disponible en GitHub (vegandevs/vegan). En la siguiente línea de código se instalará y activarán las bibliotecas del paquete R vegan.

```{r vegan, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Instalación y cargado de bibliotecas del paquete vegan
#install.packages("remotes")
#remotes::install_github("vegandevs/vegan")

library("vegan")

```

### Índice de Simpson

Cargado del libro Excel con los microorganismos identificados en cada punto muestral y cálculo del índice de Simpson.

```{r simp, echo=TRUE, message=FALSE, warning=FALSE, error=FALSE}

# Llamado de datos
diver_data <- readxl::read_excel("Data/to_palandacocha_diversity.xlsx", 1)
# Creando DataFrame
diver_data <- data.frame(diver_data)
# Nombrar filas
row.names(diver_data) <- diver_data$Site
# Eliminar columna con los nombres anteriores
diver_data <- diver_data[1:4,-1]
# Cálculo del índice Simpson
pal_rich <- specnumber(diver_data, MARGIN = 1)  # Número de species por área/grupo
pal_rich
pal_rich2 <- specnumber(diver_data, MARGIN = 2) # Frecuencia por área/grupo, asigna 1 si la                                                                   # especie fue encontrada en un área/grupo
pal_simp <- diversity(diver_data, index = "simpson")
pal_simp
pal_shan <- diversity(diver_data, index = "shannon")
pal_shan

# Plot result
pairs(cbind(pal_shan, pal_simp), pch="*", col="blue")

```

### Índice de Shannon

Descripción

## Diversidad Beta

Descripción

```{r pressure, echo=FALSE}

#her plot

```


